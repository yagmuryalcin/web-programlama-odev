@model wep_programlama_odev.Models.Project

@{
    ViewData["Title"] = "Proje Detayı";

    var tasks = Model.TaskItems?.ToList() ?? new List<wep_programlama_odev.Models.TaskItem>();
    var total = tasks.Count;
    var TamamlandiCount = tasks.Count(t => t.Status == wep_programlama_odev.Models.TaskStatus.Tamamlandi);
    var DevamEdiyorCount = tasks.Count(t => t.Status == wep_programlama_odev.Models.TaskStatus.DevamEdiyor);
    var BeklemedeCount = tasks.Count(t => t.Status == wep_programlama_odev.Models.TaskStatus.Beklemede);

    bool isAdmin = User.IsInRole("Admin");
}

<h1 class="page-title">Proje Detayı</h1>

<div class="card-custom">
    <h4 class="mb-3">Proje Bilgileri</h4>
    <hr />

    <dl class="row mb-0">
        <dt class="col-sm-3">Proje Adı</dt>
        <dd class="col-sm-9">@Model.Name</dd>

        <dt class="col-sm-3">Açıklama</dt>
        <dd class="col-sm-9">
            @if (string.IsNullOrWhiteSpace(Model.Description))
            {
                <span class="text-muted">Açıklama girilmemiş.</span>
            }
            else
            {
                @Model.Description
            }
        </dd>

        <dt class="col-sm-3">Oluşturulma Tarihi</dt>
        <dd class="col-sm-9">@Model.CreatedAt.ToString("dd.MM.yyyy HH:mm")</dd>
    </dl>
</div>

<div class="card-custom">
    <div class="d-flex justify-content-between align-items-center mb-2">
        <h4 class="mb-0">Bu Projeye Ait Görevler</h4>

        @* Admin isterse bu projeye direkt görev ekleyebilsin *@
        @if (isAdmin)
        {
            <a asp-controller="TaskItems"
               asp-action="Create"
               asp-route-projectId="@Model.Id"
               class="btn btn-success btn-sm">
                ➕ Görev Ekle
            </a>
        }
    </div>

    @if (total > 0)
    {
        <div class="mb-3 stats-bar">
            <span class="me-3"><strong>Toplam:</strong> @total</span>
            <span class="me-3"><strong>Yapılacak:</strong> @BeklemedeCount</span>
            <span class="me-3"><strong>Devam Ediyor:</strong> @DevamEdiyorCount</span>
            <span class="me-3"><strong>Tamamlandı:</strong> @TamamlandiCount</span>
        </div>
    }

    @if (!tasks.Any())
    {
        <p class="text-muted mb-0">Bu projeye ait görev bulunamadı.</p>
    }
    else
    {
        <table class="table table-hover">
            <thead>
                <tr>
                    <th>Başlık</th>
                    <th>Durum</th>
                    <th>Tarih</th>
                    <th>İşlemler</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in tasks.OrderByDescending(t => t.CreatedAt))
                {
                    string badgeClass = item.Status switch
                    {
                        wep_programlama_odev.Models.TaskStatus.Beklemede => "bg-secondary",
                        wep_programlama_odev.Models.TaskStatus.DevamEdiyor => "bg-warning text-dark",
                        wep_programlama_odev.Models.TaskStatus.Tamamlandi => "bg-success",
                        _ => "bg-dark"
                    };

                    string statusText = item.Status switch
                    {
                        wep_programlama_odev.Models.TaskStatus.Beklemede => "Yapılacak",
                        wep_programlama_odev.Models.TaskStatus.DevamEdiyor => "Devam Ediyor",
                        wep_programlama_odev.Models.TaskStatus.Tamamlandi => "Tamamlandı",
                        _ => item.Status.ToString()
                    };

                    bool isTamamlandi = item.Status == wep_programlama_odev.Models.TaskStatus.Tamamlandi;

                    <tr>
                        <td>
                            <span class="@(isTamamlandi ? "text-decoration-line-through text-muted" : "")">
                                @item.Title
                            </span>
                        </td>
                        <td>
                            <span class="badge @badgeClass">@statusText</span>
                        </td>
                        <td>@item.CreatedAt.ToString("dd.MM.yyyy")</td>
                        <td class="action-links">
                            <a asp-controller="TaskItems"
                               asp-action="Details"
                               asp-route-id="@item.Id"
                               class="text-primary">
                                Detay
                            </a>

                            @if (isAdmin)
                            {
                                <text> | </text>
                                <a asp-controller="TaskItems"
                                   asp-action="Edit"
                                   asp-route-id="@item.Id"
                                   class="text-warning">
                                    Düzenle
                                </a>
                                <text> | </text>
                                <a asp-controller="TaskItems"
                                   asp-action="Delete"
                                   asp-route-id="@item.Id"
                                   class="text-danger">
                                    Sil
                                </a>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
</div>

<div class="mt-2">
    @if (isAdmin)
    {
        <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-primary">
            Projeyi Düzenle
        </a>
    }
    <a asp-action="Index" class="btn btn-secondary">Listeye Dön</a>
</div>
